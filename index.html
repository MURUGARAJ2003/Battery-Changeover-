<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battery Changeover Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--gray-100);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    h1 i {
      color: var(--primary);
    }
    
    .controls {
      display: flex;
      gap: 12px;
    }
    
    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--gray-200);
    }
    
    button.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-300);
    }
    
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .status.ok {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .status.warn {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }
    
    .status.err {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
    
    /* Gauge Styles */
    .gauge-container {
      position: relative;
      width: 100%;
      height: 180px;
      margin: 10px 0 20px;
    }
    
    .gauge {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .gauge-value {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
    }
    
    .gauge-label {
      position: absolute;
      top: 80%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.9rem;
      color: var(--gray-400);
    }
    
    .gauge-svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    
    .gauge-background {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 10;
    }
    
    .gauge-fill {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    /* Battery Status Card */
    .battery-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .battery-icon {
      font-size: 4rem;
      margin: 15px 0;
      color: var(--primary);
    }
    
    .battery-info {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    
    .battery-info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .battery-info-value {
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .battery-info-label {
      font-size: 0.8rem;
      color: var(--gray-400);
    }
    
    /* History Table */
    .history-section {
      margin-top: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    th {
      font-weight: 600;
      color: var(--gray-400);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tbody tr {
      transition: background 0.2s ease;
    }
    
    tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .table-container {
      max-height: 420px;
      overflow: auto;
      border-radius: 12px;
    }
    
    .table-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    .table-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    
    footer {
      margin-top: 30px;
      padding: 20px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--gray-500);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .last-update {
      font-size: 0.8rem;
      color: var(--gray-500);
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-car-battery"></i> Battery Changeover — Live Dashboard</h1>
      <div class="controls">
        <button id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
        <button id="downloadCsv" class="secondary"><i class="fas fa-download"></i> Export CSV</button>
      </div>
    </header>

    <div class="dashboard-grid">
      <!-- Battery 1 Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Battery 1</div>
          <div class="status ok"><i class="fas fa-check-circle"></i> Normal</div>
        </div>
        <div class="gauge-container">
          <div class="gauge">
            <svg class="gauge-svg" viewBox="0 0 120 120">
              <circle class="gauge-background" cx="60" cy="60" r="54"></circle>
              <circle class="gauge-fill" cx="60" cy="60" r="54" 
                      stroke="#10b981" 
                      stroke-dasharray="339.292" 
                      stroke-dashoffset="135.717"></circle>
            </svg>
            <div class="gauge-value" id="b1volt">—</div>
            <div class="gauge-label">Voltage</div>
          </div>
        </div>
        <div class="last-update">Temperature: <span id="b1temp">— °C</span></div>
      </div>

      <!-- Battery 2 Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Battery 2</div>
          <div class="status warn"><i class="fas fa-exclamation-triangle"></i> Warning</div>
        </div>
        <div class="gauge-container">
          <div class="gauge">
            <svg class="gauge-svg" viewBox="0 0 120 120">
              <circle class="gauge-background" cx="60" cy="60" r="54"></circle>
              <circle class="gauge-fill" cx="60" cy="60" r="54" 
                      stroke="#f59e0b" 
                      stroke-dasharray="339.292" 
                      stroke-dashoffset="203.575"></circle>
            </svg>
            <div class="gauge-value" id="b2volt">—</div>
            <div class="gauge-label">Voltage</div>
          </div>
        </div>
        <div class="last-update">Temperature: <span id="b2temp">— °C</span></div>
      </div>

      <!-- Load Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Load</div>
          <div class="status ok"><i class="fas fa-check-circle"></i> Stable</div>
        </div>
        <div class="gauge-container">
          <div class="gauge">
            <svg class="gauge-svg" viewBox="0 0 120 120">
              <circle class="gauge-background" cx="60" cy="60" r="54"></circle>
              <circle class="gauge-fill" cx="60" cy="60" r="54" 
                      stroke="#2563eb" 
                      stroke-dasharray="339.292" 
                      stroke-dashoffset="67.858"></circle>
            </svg>
            <div class="gauge-value" id="loadvolt">—</div>
            <div class="gauge-label">Voltage</div>
          </div>
        </div>
        <div class="last-update">Last update: <span id="lastSeen">—</span></div>
      </div>
    </div>

    <!-- System Status Card -->
    <div class="card battery-status">
      <div class="card-header">
        <div class="card-title">System Status</div>
        <div class="status ok" id="systemStatus">Active Battery: <span id="activeBattery">—</span></div>
      </div>
      <i class="fas fa-bolt battery-icon"></i>
      <div class="battery-info">
        <div class="battery-info-item">
          <div class="battery-info-value" id="b1Summary">— V</div>
          <div class="battery-info-label">Battery 1</div>
        </div>
        <div class="battery-info-item">
          <div class="battery-info-value" id="b2Summary">— V</div>
          <div class="battery-info-label">Battery 2</div>
        </div>
        <div class="battery-info-item">
          <div class="battery-info-value" id="loadSummary">— V</div>
          <div class="battery-info-label">Load</div>
        </div>
      </div>
    </div>

    <!-- History Table -->
    <div class="card history-section">
      <div class="card-header">
        <div class="card-title">Changeover History</div>
        <div class="last-update">Entries are added when the active battery changes</div>
      </div>
      <div class="table-container">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Active Battery</th>
              <th>Bat1 (V)</th>
              <th>Bat2 (V)</th>
              <th>Load (V)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>
      <div>DB URL: <span id="dbUrl"></span></div>
      <div style="margin-top:6px">Battery Monitoring System v2.0</div>
    </footer>
  </div>

  <!-- Firebase v9 modular SDK -->
  <script type="module">
    // --- Firebase config (from your project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAPgh051TeLWe6SPtVhk_A241addyIyfUM",
      authDomain: "lithium-ion-battery-changeover.firebaseapp.com",
      databaseURL: "https://lithium-ion-battery-changeover-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lithium-ion-battery-changeover",
      storageBucket: "lithium-ion-battery-changeover.firebasestorage.app",
      messagingSenderId: "186918574175",
      appId: "1:186918574175:web:942c0ba9fb678c447ce3ea"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, child, query, orderByKey, limitToLast, onChildAdded
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI references
    const b1voltEl = document.getElementById('b1volt');
    const b1tempEl = document.getElementById('b1temp');
    const b2voltEl = document.getElementById('b2volt');
    const b2tempEl = document.getElementById('b2temp');
    const loadvoltEl = document.getElementById('loadvolt');
    const activeEl = document.getElementById('activeBattery');
    const statusEl = document.getElementById('systemStatus');
    const lastSeenEl = document.getElementById('lastSeen');
    const historyTbody = document.querySelector('#historyTable tbody');
    const b1SummaryEl = document.getElementById('b1Summary');
    const b2SummaryEl = document.getElementById('b2Summary');
    const loadSummaryEl = document.getElementById('loadSummary');
    document.getElementById('dbUrl').textContent = firebaseConfig.databaseURL;

    // Gauge update function
    function updateGauge(elementId, value, min = 10, max = 15) {
      const gauge = document.querySelector(`#${elementId}`).parentNode;
      const fill = gauge.querySelector('.gauge-fill');
      const circumference = 2 * Math.PI * 54; // radius is 54
      const offset = circumference - ((value - min) / (max - min)) * circumference;
      fill.style.strokeDashoffset = offset;
      
      // Update color based on value
      if (value >= 12.5) {
        fill.style.stroke = '#10b981'; // green
      } else if (value >= 11.5) {
        fill.style.stroke = '#f59e0b'; // yellow
      } else {
        fill.style.stroke = '#ef4444'; // red
      }
    }

    // helper: convert millis key to readable time
    function millisKeyToTime(k) {
      // if key is numeric millis, convert; else try parseInt
      const n = parseInt(k);
      if (!isNaN(n) && n > 1000) {
        const d = new Date(n);
        return d.toLocaleString();
      }
      // fallback: return key
      return k;
    }

    // Listen live to main nodes
    const b1Ref = ref(db, '/Battery1');
    const b2Ref = ref(db, '/Battery2');
    const loadRef = ref(db, '/Load');
    const sysRef = ref(db, '/System');

    onValue(b1Ref, (snap) => {
      const v = snap.val() || {};
      if (v.Voltage !== undefined) {
        const voltage = parseFloat(v.Voltage);
        b1voltEl.textContent = voltage.toFixed(2) + ' V';
        b1SummaryEl.textContent = voltage.toFixed(2) + ' V';
        updateGauge('b1volt', voltage);
      }
      if (v.Temperature !== undefined) b1tempEl.textContent = parseFloat(v.Temperature).toFixed(1) + ' °C';
      lastSeenEl.textContent = new Date().toLocaleString();
    });

    onValue(b2Ref, (snap) => {
      const v = snap.val() || {};
      if (v.Voltage !== undefined) {
        const voltage = parseFloat(v.Voltage);
        b2voltEl.textContent = voltage.toFixed(2) + ' V';
        b2SummaryEl.textContent = voltage.toFixed(2) + ' V';
        updateGauge('b2volt', voltage);
      }
      if (v.Temperature !== undefined) b2tempEl.textContent = parseFloat(v.Temperature).toFixed(1) + ' °C';
      lastSeenEl.textContent = new Date().toLocaleString();
    });

    onValue(loadRef, (snap) => {
      const v = snap.val() || {};
      if (v.Voltage !== undefined) {
        const voltage = parseFloat(v.Voltage);
        loadvoltEl.textContent = voltage.toFixed(2) + ' V';
        loadSummaryEl.textContent = voltage.toFixed(2) + ' V';
        updateGauge('loadvolt', voltage);
      }
      lastSeenEl.textContent = new Date().toLocaleString();
    });

    onValue(sysRef, (snap) => {
      const v = snap.val() || {};
      const st = v.Status || '—';
      const act = v.ActiveBattery || '—';
      statusEl.textContent = 'Active Battery: ' + act;
      activeEl.textContent = act;
      // color the status
      statusEl.className = 'status ' + (st.includes('NO SAFE') ? 'err' : (st.includes('Using') ? 'ok' : 'warn'));
    });

    // HISTORY: show last N entries and listen for new entries
    const historyRef = ref(db, '/History');
    // get last 200 entries to keep UI light
    const histQuery = query(historyRef, orderByKey(), limitToLast(200));

    // load existing history once
    get(histQuery).then(snap => {
      historyTbody.innerHTML = '';
      const val = snap.val() || {};
      // keys are typically millis; sort keys descending
      const keys = Object.keys(val).sort((a,b) => parseInt(b)-parseInt(a));
      keys.forEach(k => {
        appendHistoryRow(k, val[k]);
      });
    }).catch(err => console.warn('History fetch failed', err));

    // listen for new entries (child_added)
    onChildAdded(historyRef, (snap) => {
      const key = snap.key;
      const data = snap.val();
      // prepend newest on top
      prependHistoryRow(key, data);
    });

    function appendHistoryRow(key, data) {
      const tr = document.createElement('tr');
      const statusClass = (data.Status || '').includes('NO SAFE') ? 'err' : 
                         (data.Status || '').includes('Using') ? 'ok' : 'warn';
      
      tr.innerHTML = `<td>${millisKeyToTime(key)}</td>
                      <td>${escapeHtml(data.ActiveBattery || '')}</td>
                      <td>${num(data.Bat1_V)}</td>
                      <td>${num(data.Bat2_V)}</td>
                      <td>${num(data.Load_V)}</td>
                      <td><span class="status ${statusClass}">${escapeHtml(data.Status || '')}</span></td>`;
      historyTbody.appendChild(tr);
    }

    function prependHistoryRow(key, data) {
      // avoid duplicates if already present
      if ([...historyTbody.querySelectorAll('tr')].some(r => r.firstChild && r.firstChild.textContent === millisKeyToTime(key))) return;
      const tr = document.createElement('tr');
      const statusClass = (data.Status || '').includes('NO SAFE') ? 'err' : 
                         (data.Status || '').includes('Using') ? 'ok' : 'warn';
      
      tr.innerHTML = `<td>${millisKeyToTime(key)}</td>
                      <td>${escapeHtml(data.ActiveBattery || '')}</td>
                      <td>${num(data.Bat1_V)}</td>
                      <td>${num(data.Bat2_V)}</td>
                      <td>${num(data.Load_V)}</td>
                      <td><span class="status ${statusClass}">${escapeHtml(data.Status || '')}</span></td>`;
      historyTbody.insertBefore(tr, historyTbody.firstChild);
      // keep table size reasonable
      while (historyTbody.children.length > 400) historyTbody.removeChild(historyTbody.lastChild);
    }

    function num(v) { return (v === undefined || v === null) ? '—' : parseFloat(v).toFixed(2); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // manual refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
      // snapshot read
      Promise.all([get(b1Ref), get(b2Ref), get(loadRef), get(sysRef)]).then(results => {
        // update UI immediately using same handlers
        results.forEach(r => { if (r.exists()) {/* onValue already updates */} });
        alert('Refreshed (UI should already reflect live values).');
      }).catch(e=>alert('Refresh failed: '+e));
    });

    // CSV download for history
    document.getElementById('downloadCsv').addEventListener('click', async () => {
      try {
        const snap = await get(query(historyRef, orderByKey()));
        const data = snap.val() || {};
        const keys = Object.keys(data).sort((a,b)=>parseInt(a)-parseInt(b)); // oldest first
        const rows = [['Time','ActiveBattery','Bat1_V','Bat2_V','Load_V','Status']];
        keys.forEach(k=>{
          const d = data[k]||{};
          rows.push([millisKeyToTime(k), d.ActiveBattery||'', d.Bat1_V||'', d.Bat2_V||'', d.Load_V||'', d.Status||'']);
        });
        const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'history.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch(err){ alert('CSV export failed: '+err); }
    });

  </script>
</body>
</html>
