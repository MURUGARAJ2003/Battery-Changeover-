<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Battery Changeover Monitor</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAPgh051TeLWe6SPtVhk_A241addyIyfUM",
      authDomain: "lithium-ion-battery-changeover.firebaseapp.com",
      databaseURL: "https://lithium-ion-battery-changeover-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lithium-ion-battery-changeover",
      storageBucket: "lithium-ion-battery-changeover.appspot.com",
      messagingSenderId: "186918574175",
      appId: "1:186918574175:web:942c0ba9fb678c447ce3ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------------- Current Status ----------------
    const curDate = document.getElementById("curDate");
    const curTime = document.getElementById("curTime");
    const bat1v = document.getElementById("bat1v");
    const bat1t = document.getElementById("bat1t");
    const bat2v = document.getElementById("bat2v");
    const bat2t = document.getElementById("bat2t");
    const loadV = document.getElementById("load");
    const active = document.getElementById("active");

    const latestRef = query(ref(db, "History"), limitToLast(1));
    onValue(latestRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const key = Object.keys(data)[0];
      const record = data[key];

      curDate.textContent = record.Date;
      curTime.textContent = record.Time;
      bat1v.textContent = record.Battery1.Voltage.toFixed(2);
      bat1t.textContent = record.Battery1.Temperature.toFixed(1);
      bat2v.textContent = record.Battery2.Voltage.toFixed(2);
      bat2t.textContent = record.Battery2.Temperature.toFixed(1);
      loadV.textContent = record.LoadVoltage.toFixed(2);
      active.textContent = record.ActiveBattery;
    });

    // ---------------- History Table ----------------
    const historyDiv = document.getElementById("history");
    const historyRef = ref(db, "History");
    onValue(historyRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      let html = "<table><tr><th>Date</th><th>Time</th><th>Bat1(V)</th><th>Bat1(¬∞C)</th><th>Bat2(V)</th><th>Bat2(¬∞C)</th><th>Load(V)</th><th>Active</th></tr>";
      Object.keys(data).sort().reverse().forEach((key) => {
        const r = data[key];
        html += `<tr>
          <td>${r.Date}</td>
          <td>${r.Time}</td>
          <td>${r.Battery1.Voltage.toFixed(2)}</td>
          <td>${r.Battery1.Temperature.toFixed(1)}</td>
          <td>${r.Battery2.Voltage.toFixed(2)}</td>
          <td>${r.Battery2.Temperature.toFixed(1)}</td>
          <td>${r.LoadVoltage.toFixed(2)}</td>
          <td>${r.ActiveBattery}</td>
        </tr>`;
      });
      html += "</table>";
      historyDiv.innerHTML = html;
    });

    // ---------------- Fault Logs ----------------
    const faultDiv = document.getElementById("faults");
    const faultRef = ref(db, "FaultLogs");
    onValue(faultRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) { faultDiv.innerHTML = "No Faults"; return; }

      let html = "<table><tr><th>Date</th><th>Time</th><th>Active</th><th>Reason</th></tr>";
      Object.keys(data).sort().reverse().forEach((key) => {
        const r = data[key];
        html += `<tr>
          <td>${r.Date}</td>
          <td>${r.Time}</td>
          <td>${r.ActiveBattery}</td>
          <td>${r.FaultReason}</td>
        </tr>`;
      });
      html += "</table>";
      faultDiv.innerHTML = html;
    });
  </script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f7f7f7; }
    h2 { color: #333; }
    #status { padding: 15px; margin-bottom: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    table { border-collapse: collapse; width: 100%; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #4CAF50; color: white; }
    tr:nth-child(even){ background: #f2f2f2; }
  </style>
</head>
<body>
  <h2>üîã Battery Changeover System</h2>

  <!-- Current Status -->
  <div id="status">
    <h3>Current Status</h3>
    <p><b>Date:</b> <span id="curDate">--</span></p>
    <p><b>Time:</b> <span id="curTime">--</span></p>
    <p><b>Battery 1:</b> <span id="bat1v">--</span> V | <span id="bat1t">--</span> ¬∞C</p>
    <p><b>Battery 2:</b> <span id="bat2v">--</span> V | <span id="bat2t">--</span> ¬∞C</p>
    <p><b>Load Voltage:</b> <span id="load">--</span> V</p>
    <p><b>Active Battery:</b> <span id="active">--</span></p>
  </div>

  <!-- History Table -->
  <h3>üìú History Logs</h3>
  <div id="history"></div>

  <!-- Fault Logs -->
  <h3>‚ö†Ô∏è Fault Logs</h3>
  <div id="faults"></div>
</body>
</html>
