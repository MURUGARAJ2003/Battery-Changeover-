<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battery Changeover Monitor</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #2E7D32;
      --primary-light: #4CAF50;
      --primary-dark: #1B5E20;
      --secondary: #FF9800;
      --danger: #F44336;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border: #dee2e6;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: var(--primary-dark);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    h1 i {
      color: var(--primary);
    }
    
    .subtitle {
      color: var(--gray);
      font-size: 1.1rem;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-title {
      font-size: 1.3rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      border-radius: 8px;
      background: var(--light);
    }
    
    .status-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .status-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .voltage-good {
      color: var(--primary);
    }
    
    .voltage-warning {
      color: var(--secondary);
    }
    
    .voltage-danger {
      color: var(--danger);
    }
    
    .active-battery {
      background: var(--primary-light);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      text-align: center;
      margin-top: 10px;
    }
    
    .section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 1.5rem;
      color: var(--primary-dark);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background: rgba(0,0,0,0.02);
    }
    
    tr:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .fault-reason {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .no-data {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-style: italic;
    }
    
    .last-updated {
      text-align: center;
      margin-top: 20px;
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .battery-icon {
      font-size: 1.5rem;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="battery-icon">üîã</span> Battery Changeover System</h1>
      <p class="subtitle">Real-time monitoring of lithium-ion battery status and automatic changeover</p>
    </header>
    
    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><span class="battery-icon">üìä</span> Current Status</h2>
          <div class="last-updated" id="lastUpdated">Last updated: --</div>
        </div>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Battery 1 Voltage</span>
            <span class="status-value voltage-good" id="bat1v">--</span>
          </div>
          <div class="status-item">
            <span class="status-label">Battery 1 Temperature</span>
            <span class="status-value" id="bat1t">--</span>
          </div>
          <div class="status-item">
            <span class="status-label">Battery 2 Voltage</span>
            <span class="status-value voltage-good" id="bat2v">--</span>
          </div>
          <div class="status-item">
            <span class="status-label">Battery 2 Temperature</span>
            <span class="status-value" id="bat2t">--</span>
          </div>
          <div class="status-item" style="grid-column: 1 / -1;">
            <span class="status-label">Load Voltage</span>
            <span class="status-value voltage-good" id="load">--</span>
          </div>
        </div>
        <div class="active-battery" id="active">Active: --</div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><span>üìÖ</span> System Info</h2>
        </div>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Current Date</span>
            <span class="status-value" id="curDate">--</span>
          </div>
          <div class="status-item">
            <span class="status-label">Current Time</span>
            <span class="status-value" id="curTime">--</span>
          </div>
          <div class="status-item" style="grid-column: 1 / -1;">
            <span class="status-label">System Status</span>
            <span class="status-value voltage-good" id="systemStatus">Operational</span>
          </div>
        </div>
        <div class="active-battery pulse" style="background: #2196F3;">
          <span id="connectionStatus">Connected to Firebase</span>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title"><span>üìú</span> History Logs</h2>
      <div id="history" class="no-data">Loading history data...</div>
    </div>
    
    <div class="section">
      <h2 class="section-title"><span>‚ö†Ô∏è</span> Fault Logs</h2>
      <div id="faults" class="no-data">No faults detected</div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAPgh051TeLWe6SPtVhk_A241addyIyfUM",
      authDomain: "lithium-ion-battery-changeover.firebaseapp.com",
      databaseURL: "https://lithium-ion-battery-changeover-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lithium-ion-battery-changeover",
      storageBucket: "lithium-ion-battery-changeover.appspot.com",
      messagingSenderId: "186918574175",
      appId: "1:186918574175:web:942c0ba9fb678c447ce3ea"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM elements
    const curDate = document.getElementById("curDate");
    const curTime = document.getElementById("curTime");
    const bat1v = document.getElementById("bat1v");
    const bat1t = document.getElementById("bat1t");
    const bat2v = document.getElementById("bat2v");
    const bat2t = document.getElementById("bat2t");
    const loadV = document.getElementById("load");
    const active = document.getElementById("active");
    const historyDiv = document.getElementById("history");
    const faultsDiv = document.getElementById("faults");
    const lastUpdated = document.getElementById("lastUpdated");
    const systemStatus = document.getElementById("systemStatus");
    const connectionStatus = document.getElementById("connectionStatus");

    // Update last updated timestamp
    function updateLastUpdated() {
      const now = new Date();
      lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }

    // Format date from Firebase key
    function formatDateFromKey(key) {
      try {
        // Key format: "YYYY-M-D_HH:MM:SS"
        const [datePart, timePart] = key.split('_');
        const [year, month, day] = datePart.split('-');
        
        // Format date as DD/MM/YYYY
        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
      } catch (e) {
        return 'Invalid Date';
      }
    }

    // Format time from Firebase key
    function formatTimeFromKey(key) {
      try {
        // Key format: "YYYY-M-D_HH:MM:SS"
        const parts = key.split('_');
        return parts.length > 1 ? parts[1] : 'Invalid Time';
      } catch (e) {
        return 'Invalid Time';
      }
    }

    // Update voltage color based on value
    function updateVoltageColor(element, voltage) {
      element.classList.remove('voltage-good', 'voltage-warning', 'voltage-danger');
      
      if (voltage >= 10.5) {
        element.classList.add('voltage-good');
      } else if (voltage >= 9.0) {
        element.classList.add('voltage-warning');
      } else {
        element.classList.add('voltage-danger');
      }
    }

    // ---------------- Current Status ----------------
    const latestRef = database.ref('History').limitToLast(1);
    latestRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      
      const key = Object.keys(data)[0];
      const record = data[key];
      
      // Update current status
      curDate.textContent = record.Date || formatDateFromKey(key);
      curTime.textContent = record.Time || formatTimeFromKey(key);
      bat1v.textContent = record.Battery1?.Voltage?.toFixed(2) || '--';
      bat1t.textContent = record.Battery1?.Temperature?.toFixed(1) + '¬∞C' || '--';
      bat2v.textContent = record.Battery2?.Voltage?.toFixed(2) || '--';
      bat2t.textContent = record.Battery2?.Temperature?.toFixed(1) + '¬∞C' || '--';
      loadV.textContent = record.LoadVoltage?.toFixed(2) || '--';
      active.textContent = 'Active: ' + (record.ActiveBattery || '--');
      
      // Update voltage colors
      if (record.Battery1?.Voltage) updateVoltageColor(bat1v, record.Battery1.Voltage);
      if (record.Battery2?.Voltage) updateVoltageColor(bat2v, record.Battery2.Voltage);
      if (record.LoadVoltage) updateVoltageColor(loadV, record.LoadVoltage);
      
      // Update system status
      if (record.ActiveBattery === "No Safe Battery") {
        systemStatus.textContent = "Critical";
        systemStatus.classList.remove('voltage-good', 'voltage-warning');
        systemStatus.classList.add('voltage-danger');
      } else if (record.ActiveBattery && record.ActiveBattery !== "None") {
        systemStatus.textContent = "Operational";
        systemStatus.classList.remove('voltage-warning', 'voltage-danger');
        systemStatus.classList.add('voltage-good');
      }
      
      updateLastUpdated();
    });

    // ---------------- History Table ----------------
    const historyRef = database.ref('History');
    historyRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        historyDiv.innerHTML = '<div class="no-data">No history data available</div>';
        return;
      }

      let html = '<table><tr><th>Date</th><th>Time</th><th>Bat1 (V)</th><th>Bat1 (¬∞C)</th><th>Bat2 (V)</th><th>Bat2 (¬∞C)</th><th>Load (V)</th><th>Active Battery</th></tr>';
      
      Object.keys(data).sort().reverse().forEach((key) => {
        const r = data[key];
        const displayDate = r.Date || formatDateFromKey(key);
        const displayTime = r.Time || formatTimeFromKey(key);
        
        html += `<tr>
          <td>${displayDate}</td>
          <td>${displayTime}</td>
          <td>${r.Battery1?.Voltage?.toFixed(2) || '--'}</td>
          <td>${r.Battery1?.Temperature?.toFixed(1) || '--'}</td>
          <td>${r.Battery2?.Voltage?.toFixed(2) || '--'}</td>
          <td>${r.Battery2?.Temperature?.toFixed(1) || '--'}</td>
          <td>${r.LoadVoltage?.toFixed(2) || '--'}</td>
          <td>${r.ActiveBattery || '--'}</td>
        </tr>`;
      });
      
      html += '</table>';
      historyDiv.innerHTML = html;
    });

    // ---------------- Fault Logs ----------------
    const faultRef = database.ref('FaultLogs');
    faultRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        faultsDiv.innerHTML = '<div class="no-data">No faults detected</div>';
        return;
      }

      let html = '<table><tr><th>Date</th><th>Time</th><th>Bat1 (V)</th><th>Bat1 (¬∞C)</th><th>Bat2 (V)</th><th>Bat2 (¬∞C)</th><th>Load (V)</th><th>Active</th><th>Fault Reason</th></tr>';
      
      Object.keys(data).sort().reverse().forEach((key) => {
        const r = data[key];
        const displayDate = r.Date || formatDateFromKey(key);
        const displayTime = r.Time || formatTimeFromKey(key);
        
        html += `<tr>
          <td>${displayDate}</td>
          <td>${displayTime}</td>
          <td>${r.Battery1Voltage?.toFixed(2) || '--'}</td>
          <td>${r.Battery1Temp?.toFixed(1) || '--'}</td>
          <td>${r.Battery2Voltage?.toFixed(2) || '--'}</td>
          <td>${r.Battery2Temp?.toFixed(1) || '--'}</td>
          <td>${r.LoadVoltage?.toFixed(2) || '--'}</td>
          <td>${r.ActiveBattery || '--'}</td>
          <td class="fault-reason" title="${r.FaultReason || 'Unknown'}">${r.FaultReason || 'Unknown'}</td>
        </tr>`;
      });
      
      html += '</table>';
      faultsDiv.innerHTML = html;
    });

    // Connection status monitoring
    database.ref('.info/connected').on('value', (snapshot) => {
      if (snapshot.val() === true) {
        connectionStatus.textContent = "Connected to Firebase";
        connectionStatus.parentElement.style.background = "#4CAF50";
      } else {
        connectionStatus.textContent = "Disconnected from Firebase";
        connectionStatus.parentElement.style.background = "#F44336";
      }
    });

    // Initial call to update last updated
    updateLastUpdated();
  </script>
</body>
</html>
